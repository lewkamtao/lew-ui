# 文档 & 测试最低要求

> **重要性**：⭐⭐⭐⭐  
> 完善的文档和测试是高质量组件库的保证。

## 核心原则

### 1. 文档先行
- 在实现功能前先思考如何使用
- 文档即设计，写文档过程中发现 API 问题
- 好的文档能减少 80% 的用户问题

### 2. 最小化测试
- 不追求 100% 覆盖率
- 专注于关键功能和边界情况
- 测试应该帮助开发而非拖慢开发

### 3. 可维护性
- 文档和代码同步更新
- 测试代码也要保持简洁
- 示例代码应该是真实可运行的

## 文档规范

### 必需文档内容

每个组件必须包含以下文档（通常在 docs 目录或组件注释中）：

#### 1. 基础说明

```markdown
# Button 按钮

## 何时使用

- 标记了一个（或封装一组）操作命令，响应用户点击行为，触发相应的业务逻辑
- 在表单中提交操作
- 需要引导用户进行主要操作时

## 基本用法

最简单的用法，展示按钮的几种基本类型。

```vue
<template>
  <lew-button>默认按钮</lew-button>
  <lew-button type="fill">填充按钮</lew-button>
  <lew-button type="light">浅色按钮</lew-button>
  <lew-button type="ghost">幽灵按钮</lew-button>
  <lew-button type="text">文字按钮</lew-button>
</template>
```
```

#### 2. API 文档

```markdown
## Props

| 属性 | 说明 | 类型 | 默认值 | 必填 |
|------|------|------|--------|------|
| size | 按钮尺寸 | `'mini' \| 'small' \| 'medium' \| 'large'` | `'medium'` | 否 |
| type | 按钮类型 | `'fill' \| 'light' \| 'ghost' \| 'text'` | `'light'` | 否 |
| color | 按钮颜色（主题色或自定义） | `string` | `'primary'` | 否 |
| disabled | 是否禁用 | `boolean` | `false` | 否 |
| loading | 是否加载中 | `boolean` | `false` | 否 |
| text | 按钮文字（也可使用默认插槽） | `string` | - | 否 |
| request | 异步请求函数，传入后点击自动处理 loading | `() => Promise<void>` | - | 否 |
| icon | 图标名称 | `string` | - | 否 |
| iconPosition | 图标位置 | `'left' \| 'right'` | `'left'` | 否 |
| round | 是否圆角 | `boolean` | `false` | 否 |
| singleIcon | 是否单图标按钮（无文字） | `boolean` | `false` | 否 |

## Events

| 事件名 | 说明 | 回调参数 |
|--------|------|----------|
| click | 点击按钮时触发（disabled 或 loading 时不触发） | `(event: MouseEvent) => void` |

## Slots

| 插槽名 | 说明 | 作用域 |
|--------|------|--------|
| default | 按钮内容 | - |
| icon | 自定义图标 | - |

## CSS 变量

| 变量名 | 说明 | 默认值 |
|--------|------|--------|
| --lew-button-bg | 背景色 | `transparent` |
| --lew-button-color | 文字颜色 | `var(--lew-color-primary-dark)` |
| --lew-button-height | 高度 | `32px` (medium) |
| --lew-button-padding | 内边距 | `0 16px` |
| --lew-button-border-radius | 圆角 | `var(--lew-border-radius-md)` |
| --lew-button-hover-bg | 悬停背景色 | `var(--lew-color-primary-light)` |
```

#### 3. 使用示例

```markdown
## 不同尺寸

按钮有四种尺寸：mini、small、medium（默认）、large。

```vue
<template>
  <lew-button size="mini">迷你按钮</lew-button>
  <lew-button size="small">小型按钮</lew-button>
  <lew-button size="medium">中等按钮</lew-button>
  <lew-button size="large">大型按钮</lew-button>
</template>
```

## 加载状态

通过 `loading` 属性可以让按钮处于加载中状态。

```vue
<template>
  <lew-button :loading="loading" @click="handleClick">
    点击加载
  </lew-button>
</template>

<script setup lang="ts">
import { ref } from 'vue'

const loading = ref(false)

const handleClick = () => {
  loading.value = true
  setTimeout(() => {
    loading.value = false
  }, 2000)
}
</script>
```

## 异步请求

传入 `request` 函数，点击按钮时会自动处理 loading 状态。

```vue
<template>
  <lew-button :request="handleRequest">
    异步请求
  </lew-button>
</template>

<script setup lang="ts">
const handleRequest = async () => {
  // 模拟异步请求
  await new Promise(resolve => setTimeout(resolve, 2000))
  console.log('请求完成')
}
</script>
```

## 禁用状态

通过 `disabled` 属性禁用按钮。

```vue
<template>
  <lew-button disabled>禁用按钮</lew-button>
</template>
```

## 自定义颜色

可以通过 CSS 变量自定义按钮样式。

```vue
<template>
  <lew-button 
    class="custom-button"
    type="fill"
  >
    自定义按钮
  </lew-button>
</template>

<style>
.custom-button {
  --lew-button-bg: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
  --lew-button-hover-bg: linear-gradient(45deg, #5568d3 0%, #6a4193 100%);
}
</style>
```
```

#### 4. 注意事项（如有）

```markdown
## 注意事项

- 当同时设置 `text` 和默认插槽时，默认插槽优先
- `request` 函数执行期间，按钮会自动进入 loading 状态且不可点击
- 当 `disabled` 或 `loading` 为 `true` 时，不会触发 `click` 事件
- 单图标按钮（`singleIcon`）会自动调整内边距为正方形
```

### Props 文档说明

**重要**：Props 的文档说明通过在线文档系统的国际化配置提供，**不需要**在 props.ts 中添加 JSDoc 注释。

#### ❌ 不推荐：在 props.ts 中添加 JSDoc

```typescript
// ❌ 不需要这样做
export const buttonProps = {
  /**
   * 按钮尺寸
   * @default 'medium'
   */
  size: {
    type: String as PropType<'mini' | 'small' | 'medium' | 'large'>,
    default: 'medium'
  }
}
```

#### ✅ 推荐：在国际化配置中添加说明

```typescript
// docs/locals/zh.ts
export default {
  components: {
    button: {
      props: {
        size: '按钮尺寸',  // ✅ 在这里添加说明
        type: '类型',
        // ...
      }
    }
  }
}

// docs/locals/en.ts
export default {
  components: {
    button: {
      props: {
        size: 'Button Size',  // ✅ 在这里添加说明
        type: 'Type',
        // ...
      }
    }
  }
}
```

**原因**：
1. 避免重复：不需要在代码和文档中重复维护相同的说明
2. 国际化支持：文档说明可以支持多语言
3. 统一管理：所有文档文本集中在国际化配置中
4. 代码简洁：保持 props 定义简洁清晰

**IDE 提示**：虽然没有 JSDoc，但用户可以通过：
- 查看在线文档获取详细说明
- TypeScript 类型定义已经提供了类型提示
- 文档扩展属性（如 `typeValues`）提供了可选值提示

### 组件使用说明（README）

复杂组件可以在组件目录下添加 README.md：

```markdown
# Button 组件

## 文件结构

```
button/
├── index.ts          # 组件导出
└── src/
    ├── LewButton.vue # 组件实现
    ├── props.ts      # Props 定义
    └── types.ts      # 类型定义
```

## 开发指南

### 修改说明
- 修改 Props 时需要同步更新类型和文档
- 样式修改使用 CSS 变量，避免硬编码
- 新增功能需要添加对应示例

### 相关组件
- ButtonGroup: 按钮组（未实现）

### 已知问题
- 暂无
```

## 测试规范

### 测试分类

#### 1. 单元测试（必需）

测试组件的基本功能和边界情况：

```typescript
// lib/components/general/button/__tests__/button.test.ts

import { describe, it, expect, vi } from 'vitest'
import { mount } from '@vue/test-utils'
import LewButton from '../src/LewButton.vue'

describe('LewButton', () => {
  // 基础渲染
  it('renders properly', () => {
    const wrapper = mount(LewButton, {
      props: { text: 'Hello' }
    })
    expect(wrapper.text()).toBe('Hello')
  })

  // Props 测试
  it('renders different sizes', () => {
    const sizes = ['mini', 'small', 'medium', 'large'] as const
    
    sizes.forEach(size => {
      const wrapper = mount(LewButton, {
        props: { size, text: 'Button' }
      })
      expect(wrapper.classes()).toContain(`lew-button-size-${size}`)
    })
  })

  it('renders different types', () => {
    const types = ['fill', 'light', 'ghost', 'text'] as const
    
    types.forEach(type => {
      const wrapper = mount(LewButton, {
        props: { type, text: 'Button' }
      })
      expect(wrapper.classes()).toContain(`lew-button-type-${type}`)
    })
  })

  // Disabled 状态
  it('disables button when disabled prop is true', () => {
    const wrapper = mount(LewButton, {
      props: { disabled: true, text: 'Button' }
    })
    expect(wrapper.attributes('disabled')).toBeDefined()
  })

  // 事件测试
  it('emits click event when clicked', async () => {
    const wrapper = mount(LewButton, {
      props: { text: 'Button' }
    })
    
    await wrapper.trigger('click')
    expect(wrapper.emitted('click')).toBeTruthy()
  })

  it('does not emit click when disabled', async () => {
    const wrapper = mount(LewButton, {
      props: { disabled: true, text: 'Button' }
    })
    
    await wrapper.trigger('click')
    expect(wrapper.emitted('click')).toBeFalsy()
  })

  // Loading 状态
  it('shows loading icon when loading', () => {
    const wrapper = mount(LewButton, {
      props: { loading: true, text: 'Button' }
    })
    expect(wrapper.find('.lew-button-loading-icon').exists()).toBe(true)
  })

  // 异步请求测试
  it('handles request function properly', async () => {
    const mockRequest = vi.fn(async () => {
      await new Promise(resolve => setTimeout(resolve, 100))
    })
    
    const wrapper = mount(LewButton, {
      props: { request: mockRequest, text: 'Button' }
    })
    
    await wrapper.trigger('click')
    expect(mockRequest).toHaveBeenCalled()
  })

  // Slot 测试
  it('renders default slot content', () => {
    const wrapper = mount(LewButton, {
      slots: {
        default: 'Slot Content'
      }
    })
    expect(wrapper.text()).toBe('Slot Content')
  })

  // 边界情况
  it('handles undefined props gracefully', () => {
    const wrapper = mount(LewButton)
    expect(wrapper.exists()).toBe(true)
  })
})
```

#### 2. 类型测试（推荐）

确保类型定义正确：

```typescript
// lib/components/general/button/__tests__/types.test-d.ts

import { describe, expectTypeOf, it } from 'vitest'
import type { ButtonProps } from '../src/props'
import LewButton from '../src/LewButton.vue'

describe('Button Types', () => {
  it('props type is correct', () => {
    expectTypeOf<ButtonProps>().toMatchTypeOf<{
      size?: 'mini' | 'small' | 'medium' | 'large'
      type?: 'fill' | 'light' | 'ghost' | 'text'
      disabled?: boolean
      loading?: boolean
      text?: string
      request?: () => Promise<void>
    }>()
  })

  it('component props type is correct', () => {
    expectTypeOf(LewButton).toHaveProperty('props')
  })
})
```

#### 3. 快照测试（可选）

确保组件渲染输出的稳定性：

```typescript
// lib/components/general/button/__tests__/snapshot.test.ts

import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import LewButton from '../src/LewButton.vue'

describe('Button Snapshots', () => {
  it('matches snapshot for default button', () => {
    const wrapper = mount(LewButton, {
      props: { text: 'Button' }
    })
    expect(wrapper.html()).toMatchSnapshot()
  })

  it('matches snapshot for different types', () => {
    const types = ['fill', 'light', 'ghost', 'text'] as const
    
    types.forEach(type => {
      const wrapper = mount(LewButton, {
        props: { type, text: 'Button' }
      })
      expect(wrapper.html()).toMatchSnapshot()
    })
  })
})
```

### 测试覆盖目标

#### 必须测试（⭐⭐⭐）
- 组件能正常渲染
- Props 按预期工作
- 事件正确触发
- 禁用/加载状态正确
- 边界情况不报错

#### 应该测试（⭐⭐）
- 不同 Props 组合
- Slots 渲染
- 条件渲染逻辑
- 计算属性正确性

#### 可以测试（⭐）
- 样式类名正确
- CSS 变量设置
- 类型定义
- 快照对比

### 测试原则

#### ✅ 好的测试

```typescript
// ✅ 测试行为而非实现
it('disables button when disabled prop is true', () => {
  const wrapper = mount(LewButton, {
    props: { disabled: true }
  })
  expect(wrapper.attributes('disabled')).toBeDefined()
})

// ✅ 测试用户可见的结果
it('shows loading icon when loading', () => {
  const wrapper = mount(LewButton, {
    props: { loading: true }
  })
  expect(wrapper.find('.lew-button-loading-icon').isVisible()).toBe(true)
})

// ✅ 清晰的测试描述
it('emits click event with MouseEvent when button is clicked', async () => {
  // ...
})
```

#### ❌ 不好的测试

```typescript
// ❌ 测试实现细节
it('has _loading ref', () => {
  const wrapper = mount(LewButton)
  expect(wrapper.vm._loading).toBeDefined()  // 实现细节
})

// ❌ 过度依赖内部结构
it('calls handleClick when clicked', () => {
  const wrapper = mount(LewButton)
  const spy = vi.spyOn(wrapper.vm, 'handleClick')  // 内部方法
  // ...
})

// ❌ 测试框架行为
it('Vue reactive works', () => {
  const state = ref(0)
  state.value++
  expect(state.value).toBe(1)  // 测试 Vue 而非组件
})
```

### 测试工具

#### Vitest 配置

```typescript
// vitest.config.ts
import { defineConfig } from 'vitest/config'
import vue from '@vitejs/plugin-vue'

export default defineConfig({
  plugins: [vue()],
  test: {
    environment: 'jsdom',
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: [
        'node_modules/',
        'dist/',
        '**/*.d.ts',
        '**/*.config.*',
        '**/mockData.ts',
        'docs/'
      ]
    }
  }
})
```

#### 测试命令

```json
{
  "scripts": {
    "test": "vitest",
    "test:ui": "vitest --ui",
    "test:coverage": "vitest --coverage"
  }
}
```

## 最低要求清单

### 文档最低要求（必需）
- [ ] 组件说明（何时使用）
- [ ] 基本使用示例
- [ ] Props API 表格
- [ ] Events API 表格（如有）
- [ ] Slots API 表格（如有）
- [ ] CSS 变量表格（如有可定制变量）
- [ ] 至少 3 个实际使用示例
- [ ] 在国际化配置中添加 Props/Events/Slots 说明

### 测试最低要求（推荐）
- [ ] 基础渲染测试
- [ ] 主要 Props 测试
- [ ] 事件触发测试
- [ ] 禁用/加载状态测试
- [ ] 边界情况测试
- [ ] 核心功能覆盖率 > 60%

### 额外要求（可选）
- [ ] 复杂示例（组合使用）
- [ ] 注意事项说明
- [ ] 类型测试
- [ ] 快照测试
- [ ] 性能测试
- [ ] 可访问性测试

## 文档示例模板

可以参考以下模板快速编写组件文档：

```markdown
# ComponentName 组件名

简短描述组件的作用。

## 何时使用

- 使用场景 1
- 使用场景 2
- 使用场景 3

## 基本用法

描述最简单的用法。

```vue
<template>
  <lew-component>基本示例</lew-component>
</template>
```

## 示例 2

描述第二个示例。

```vue
<template>
  <!-- 示例代码 -->
</template>

<script setup lang="ts">
// 脚本代码
</script>
```

## Props

| 属性 | 说明 | 类型 | 默认值 | 必填 |
|------|------|------|--------|------|
| prop1 | 说明 | `type` | `default` | 否 |

## Events

| 事件名 | 说明 | 回调参数 |
|--------|------|----------|
| event1 | 说明 | `(param: Type) => void` |

## Slots

| 插槽名 | 说明 | 作用域 |
|--------|------|--------|
| slot1 | 说明 | - |

## CSS 变量

| 变量名 | 说明 | 默认值 |
|--------|------|--------|
| --lew-component-xxx | 说明 | `value` |

## 注意事项

- 注意事项 1
- 注意事项 2
```

## 验证清单

发布组件前检查：
- [ ] 文档完整（至少包含最低要求）
- [ ] 示例代码可运行
- [ ] API 表格与代码一致
- [ ] 国际化配置完整（Props/Events/Slots 说明）
- [ ] 测试覆盖核心功能
- [ ] 测试全部通过（`pnpm test`）
- [ ] 类型检查通过（`pnpm typecheck`）

## 在线文档规范（docs 目录）

### 文档目录结构

每个组件在 `docs/docs/` 下必须有对应的文档目录：

```
docs/docs/{component-name}/
├── api/
│   ├── index.ts       # API 文档导出入口
│   ├── props.ts       # Props 文档（必需）
│   ├── emits.ts       # Emits 文档（如有事件）
│   ├── slots.ts       # Slots 文档（如有插槽）
│   └── model.ts       # v-model 文档（如支持）
├── demo/
│   ├── index.ts       # 示例导出入口
│   ├── Demo{Name}1.vue
│   ├── Demo{Name}2.vue
│   └── ...
├── Demo{Name}.vue     # 示例容器组件
└── index.ts           # 组件文档入口
```

### Props 文档（必需）

```typescript
// docs/docs/button/api/props.ts
import { convertProps } from 'docs/lib/utils'
import { buttonProps } from 'lew-ui'

export default {
  title: 'Props',
  columnsKey: 'props',
  data: convertProps(buttonProps),
}
```

**要点**：
- 必须从 `lew-ui` 导入组件的 props 对象
- 使用 `convertProps` 工具函数转换
- `columnsKey` 必须为 `'props'`

### Emits 文档（如有事件）

```typescript
// docs/docs/button/api/emits.ts
import { convertEmits } from 'docs/lib/utils'
import { buttonEmits } from 'lew-ui'

export default {
  title: 'Emits',
  columnsKey: 'emits',
  orderNum: 99,
  data: convertEmits(buttonEmits),
}
```

**要点**：
- 必须从 `lew-ui` 导入组件的 emits 对象
- 使用 `convertEmits` 工具函数转换
- `columnsKey` 必须为 `'emits'`
- `orderNum: 99` 让事件文档排在最后

### API 导出入口

```typescript
// docs/docs/button/api/index.ts
export { default as emits } from './emits'
export { default as props } from './props'
// 如有其他 API 文档也在此导出
```

### 国际化配置（必需）

每个组件的文档文本必须在 `docs/locals/` 下配置：

#### 中文（zh.ts）

```typescript
// docs/locals/zh.ts
export default {
  components: {
    button: {
      name: '按钮 Button',
      description: '点击它，让交互更加丝滑流畅',
      demo1: {
        title: '基础用法',
      },
      // ... 其他示例
      props: {
        text: '按钮文字',
        type: '类型',
        size: '尺寸',
        // ... 其他 props 说明
      },
      emits: {
        click: '点击按钮时触发（禁用或加载状态下不触发）',
        // ... 其他事件说明
      },
      // 如有 slots
      slots: {
        default: '按钮内容',
      },
      // 如有 model
      model: {
        modelValue: '绑定值',
      },
    },
  },
}
```

#### 英文（en.ts）

```typescript
// docs/locals/en.ts
export default {
  components: {
    button: {
      name: 'Button',
      description: 'Click it to make interactions smoother',
      demo1: {
        title: 'Basic Usage',
      },
      // ... other demos
      props: {
        text: 'Button Text',
        type: 'Type',
        size: 'Size',
        // ... other props descriptions
      },
      emits: {
        click: 'Triggered when the button is clicked (not triggered when disabled or loading)',
        // ... other events descriptions
      },
    },
  },
}
```

### 组件导出要求

为了让文档系统能正确读取 props 和 emits，组件必须导出这些对象：

```typescript
// lib/components/general/button/index.ts
import LewButton from './src/LewButton.vue'
import { buttonEmits, type LewButtonEmits } from './src/emits'
import { buttonProps, type LewButtonProps } from './src/props'

export { LewButton }
export type { LewButtonEmits, LewButtonProps }

// ✅ 导出 props 和 emits 对象供文档使用
export { buttonEmits, buttonProps }

export default LewButton
```

### 文档工具函数

文档系统提供了以下工具函数：

- `convertProps(propsObject)` - 转换 props 对象为文档表格数据
- `convertEmits(emitsObject)` - 转换 emits 对象为文档表格数据
- `convertSlots(slotsObject)` - 转换 slots 对象为文档表格数据

### 文档显示逻辑

文档表格由 `docs/layout/LewDocsTables.vue` 组件渲染：

- **Name 列**：显示 prop/emit/slot 名称
- **Description 列**：从国际化配置读取说明文本
- **Type 列**：显示类型（仅 props）
- **Default 列**：显示默认值（仅 props）
- **Argument 列**：显示参数（仅 emits）

国际化键名格式：`components.{componentName}.{apiType}.{name}`

例如：
- Props: `components.button.props.size`
- Emits: `components.button.emits.click`
- Slots: `components.button.slots.default`

### 文档完整性检查清单

创建组件文档时确认：
- [ ] 创建了 `docs/docs/{component-name}` 目录
- [ ] 创建了 `api/props.ts`（必需）
- [ ] 创建了 `api/emits.ts`（如有事件）
- [ ] 创建了 `api/index.ts` 并导出所有 API
- [ ] 在 `docs/locals/zh.ts` 添加了中文配置
- [ ] 在 `docs/locals/en.ts` 添加了英文配置
- [ ] 组件 `index.ts` 导出了 props/emits 对象
- [ ] 运行 `pnpm typecheck` 通过
- [ ] 文档页面能正确显示

### 常见错误

❌ **错误 1**：文档导入找不到 props/emits

```typescript
// ❌ 错误：组件没有导出 props 对象
import { buttonProps } from 'lew-ui'  // Error: 'buttonProps' not exported
```

**解决方案**：在组件 `index.ts` 中导出：
```typescript
export { buttonProps, buttonEmits }
```

❌ **错误 2**：文档表格显示空白或错误

**原因**：国际化配置缺失或路径错误

**解决方案**：确保在 `docs/locals/{lang}.ts` 中添加了完整配置

❌ **错误 3**：API 导出入口遗漏

```typescript
// ❌ 错误：api/index.ts 没有导出 emits
export { default as props } from './props'
// 缺少 emits 导出
```

**解决方案**：
```typescript
export { default as emits } from './emits'
export { default as props } from './props'
```

---

**记住**：好的文档和测试是组件库成功的关键！
