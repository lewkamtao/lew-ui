<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>Code Persona Background</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"
    />

    <style>
      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        width: 100%;
        height: 100%;
        background: #0d1117;
        overflow: hidden;
        font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, Consolas, 'Liberation Mono', monospace;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* 背景容器 */
      .scene {
        position: relative;
        width: 1080px;
        height: 1920px;
        max-width: 100vw;
        max-height: 100vh;
        aspect-ratio: 1080 / 1920;
        background-color: #0d1117;
        background-image:
          radial-gradient(ellipse at 30% 20%, rgba(88, 166, 255, 0.06), transparent 50%),
          radial-gradient(ellipse at 70% 80%, rgba(210, 168, 255, 0.05), transparent 50%);
        box-shadow: 0 0 100px rgba(0, 0, 0, 0.5);
        overflow: hidden;
      }

      .scene::-webkit-scrollbar {
        display: none;
      }

      /* 代码层 */
      .code-layer {
        position: absolute;
        line-height: 1.6;
        white-space: pre;
        user-select: none;
        pointer-events: none;
        background: transparent;
      }

      .code-layer pre {
        margin: 0;
        padding: 0;
        background: transparent !important;
        overflow: visible !important;
      }

      .code-layer code {
        background: transparent !important;
        padding: 0;
        color: #c9d1d9 !important;
        overflow: visible !important;
      }

      /* 隐藏所有可能的滚动条 */
      .code-layer pre::-webkit-scrollbar,
      .code-layer code::-webkit-scrollbar,
      .hljs::-webkit-scrollbar {
        display: none !important;
        width: 0 !important;
        height: 0 !important;
      }

      /* 覆盖 highlight.js 默认颜色，确保无黑色 */
      .code-layer .hljs {
        color: #c9d1d9 !important;
        background: transparent !important;
      }
      .code-layer .hljs-keyword {
        color: #ff7b72 !important;
      }
      .code-layer .hljs-built_in {
        color: #ffa657 !important;
      }
      .code-layer .hljs-type {
        color: #ff7b72 !important;
      }
      .code-layer .hljs-literal {
        color: #79c0ff !important;
      }
      .code-layer .hljs-number {
        color: #79c0ff !important;
      }
      .code-layer .hljs-operator {
        color: #c9d1d9 !important;
      }
      .code-layer .hljs-punctuation {
        color: #c9d1d9 !important;
      }
      .code-layer .hljs-property {
        color: #79c0ff !important;
      }
      .code-layer .hljs-regexp {
        color: #a5d6ff !important;
      }
      .code-layer .hljs-string {
        color: #a5d6ff !important;
      }
      .code-layer .hljs-char {
        color: #a5d6ff !important;
      }
      .code-layer .hljs-subst {
        color: #c9d1d9 !important;
      }
      .code-layer .hljs-symbol {
        color: #79c0ff !important;
      }
      .code-layer .hljs-variable {
        color: #ffa657 !important;
      }
      .code-layer .hljs-template-variable {
        color: #ffa657 !important;
      }
      .code-layer .hljs-link {
        color: #a5d6ff !important;
      }
      .code-layer .hljs-selector-tag {
        color: #7ee787 !important;
      }
      .code-layer .hljs-selector-id {
        color: #79c0ff !important;
      }
      .code-layer .hljs-selector-class {
        color: #79c0ff !important;
      }
      .code-layer .hljs-comment {
        color: #8b949e !important;
      }
      .code-layer .hljs-doctag {
        color: #8b949e !important;
      }
      .code-layer .hljs-meta {
        color: #8b949e !important;
      }
      .code-layer .hljs-title {
        color: #d2a8ff !important;
      }
      .code-layer .hljs-title.function_ {
        color: #d2a8ff !important;
      }
      .code-layer .hljs-title.class_ {
        color: #ffa657 !important;
      }
      .code-layer .hljs-params {
        color: #c9d1d9 !important;
      }
      .code-layer .hljs-attr {
        color: #79c0ff !important;
      }
      .code-layer .hljs-attribute {
        color: #79c0ff !important;
      }
      .code-layer .hljs-name {
        color: #7ee787 !important;
      }

      /* 透明度层级 - 基础样式，具体大小由 JS 随机设置 */
      .code-layer.depth-1 {
        opacity: 0.1;
      }
      .code-layer.depth-2 {
        opacity: 0.15;
      }
      .code-layer.depth-3 {
        opacity: 0.22;
      }
      .code-layer.depth-4 {
        opacity: 0.3;
      }
      .code-layer.depth-5 {
        opacity: 0.4;
      }

      /* 中央文案 - 无背景，融入代码 */
      .center-text {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
      }

      .center-text pre {
        margin: 0;
        padding: 0;
        background: transparent !important;
      }

      .center-text code {
        font-size: clamp(22px, 3.5vw, 32px) !important;
        line-height: 1.7;
        background: transparent !important;
        text-shadow: 0 0 40px rgba(0, 0, 0, 0.8);
        color: #c9d1d9 !important;
      }

      /* 中央代码颜色 */
      .center-text .hljs {
        color: #c9d1d9 !important;
        background: transparent !important;
      }
      .center-text .hljs-keyword {
        color: #ff7b72 !important;
      }
      .center-text .hljs-built_in {
        color: #ffa657 !important;
      }
      .center-text .hljs-type {
        color: #ff7b72 !important;
      }
      .center-text .hljs-literal {
        color: #79c0ff !important;
      }
      .center-text .hljs-number {
        color: #79c0ff !important;
      }
      .center-text .hljs-property {
        color: #79c0ff !important;
      }
      .center-text .hljs-string {
        color: #a5d6ff !important;
      }
      .center-text .hljs-title {
        color: #d2a8ff !important;
      }
      .center-text .hljs-title.function_ {
        color: #d2a8ff !important;
      }
      .center-text .hljs-title.class_ {
        color: #ffa657 !important;
      }
      .center-text .hljs-params {
        color: #c9d1d9 !important;
      }
      .center-text .hljs-attr {
        color: #79c0ff !important;
      }

      /* 导出按钮 */
      .export-btn {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        padding: 12px 24px;
        background: rgba(13, 17, 23, 0.9);
        border: 1px solid rgba(201, 209, 217, 0.2);
        border-radius: 8px;
        color: #c9d1d9;
        font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, Consolas, monospace;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
      }

      .export-btn:hover {
        background: rgba(13, 17, 23, 0.95);
        border-color: rgba(201, 209, 217, 0.4);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      .export-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
    </style>
  </head>

  <body>
    <button class="export-btn" id="exportBtn">导出图片</button>
    <div class="scene" id="scene">
      <div class="center-text">
        <pre><code class="language-typescript" id="slogan"></code></pre>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/typescript.min.js"></script>
    <script>
      const scene = document.getElementById('scene')
      const sloganEl = document.getElementById('slogan')

      // 代码片段库 - 纯文本，由 highlight.js 高亮
      const codeSnippets = [
        `const model = train(data)`,

        `function predict(input: Tensor) {
  return model.forward(input)
}`,

        `type NeuralNetwork = {
  layers: Layer[]
  weights: Matrix
}`,

        `async function inference(query: string) {
  return await ai.process(query)
}`,

        `const gpu = initGPU()
const tensor = createTensor(data)`,

        `class CNN extends Model {
  forward(x: Tensor): Tensor
}`,

        `function backprop(loss: number) {
  return gradient.compute(loss)
}`,

        `type LLM = Transformer & {
  tokens: 2048
}`,

        `const prompt = 'Generate code'
const response = generate(prompt)`,

        `interface Agent {
  think(): Action
  act(): Result
}`,

        `function embed(text: string): Vector {
  return encoder.encode(text)
}`,

        `const reward = computeReward(state, action)`,

        `type Dataset = Tensor[]
const trainSet: Dataset = loadData()`,

        `async function fineTune(model: Model) {
  await model.train(epochs)
}`,

        `const loss = mse(pred, target)
const grad = backward(loss)`,

        `class Transformer {
  forward(x: Tensor): Tensor
}`,

        `const image = loadImage('input.jpg')
const result = cv.detect(image)`,

        `function optimize(params: Params) {
  return optimizer.step(params)
}`,

        `type GPT = {
  vocab: 50000
  context: 4096
}`,

        `const activation = relu(x)
const output = softmax(logits)`,

        `interface API {
  endpoint: string
  key: string
}`,

        `const tokens = tokenize(text)
const embeddings = encode(tokens)`,

        `function attention(q, k, v) {
  return softmax(q @ k.T / sqrt(d)) @ v
}`,

        `type Robot = Agent & Actuator
const robot: Robot = createRobot()`,

        `const batch = sample(dataset, 32)
const loss = compute(batch)`,

        `class GAN {
  generate(noise): Image
  discriminate(img): boolean
}`,

        `const qubit = createQubit()
const state = measure(qubit)`,

        `function cluster(points: Point[]) {
  return kmeans(points, k)
}`,

        `type Sensor = Camera | Lidar
const sensors: Sensor[] = init()`,

        `const policy = createPolicy(network)
const action = policy.select(state)`,

        `interface MLModel {
  predict(x: Input): Output
  train(data: Dataset): void
}`,

        `const layer1 = Dense(128, relu)
const layer2 = Dense(64, relu)`,

        `function mutate(genome: Genome) {
  return genome.evolve(rate)
}`,

        `type Tensor = Float32Array[]
const x: Tensor = zeros([1, 784])`,

        `const encoder = BERT()
const decoder = GPT()`,

        `class AutoEncoder {
  encode(x): Latent
  decode(z): Reconstructed
}`,

        `const workers = spawn(8)
await parallelTrain(workers, data)`,

        `function transform(input: Tensor) {
  return input.reshape([-1, 784])
}`,

        `type HyperParams = {
  lr: 0.001
  batch: 32
  epochs: 100
}`,
      ]

      // 使用 highlight.js 高亮代码
      function highlightCode(code) {
        if (typeof hljs !== 'undefined') {
          return hljs.highlight(code, { language: 'typescript' }).value
        }
        return code
      }

      // 布局配置
      const SCENE_WIDTH = 1080
      const SCENE_HEIGHT = 1920

      // 中心区域排除（为主文案留空）
      const CENTER_ZONE = {
        left: SCENE_WIDTH * 0.1,
        right: SCENE_WIDTH * 0.9,
        top: SCENE_HEIGHT * 0.4,
        bottom: SCENE_HEIGHT * 0.56,
      }

      // 检查位置是否在中心区域
      function isInCenterZone(x, y, w, h) {
        return !(x + w < CENTER_ZONE.left || x > CENTER_ZONE.right || y + h < CENTER_ZONE.top || y > CENTER_ZONE.bottom)
      }

      // 生成均匀分布的位置
      function generateGridPositions() {
        const positions = []

        // 定义区域：上部、左侧、右侧、下部
        const regions = [
          // 上部区域 (4行 x 4列)
          ...generateRegion(0, 0, SCENE_WIDTH, SCENE_HEIGHT * 0.36, 4, 4),
          // 左侧区域 (中间高度)
          ...generateRegion(0, SCENE_HEIGHT * 0.34, SCENE_WIDTH * 0.22, SCENE_HEIGHT * 0.28, 1, 3),
          // 右侧区域 (中间高度)
          ...generateRegion(SCENE_WIDTH * 0.78, SCENE_HEIGHT * 0.34, SCENE_WIDTH * 0.22, SCENE_HEIGHT * 0.28, 1, 3),
          // 下部上层 (2行 x 4列) - 靠近中央
          ...generateRegion(0, SCENE_HEIGHT * 0.57, SCENE_WIDTH, SCENE_HEIGHT * 0.16, 4, 2),
          // 下部下层 (3行 x 4列) - 底部区域
          ...generateRegion(0, SCENE_HEIGHT * 0.73, SCENE_WIDTH, SCENE_HEIGHT * 0.27, 4, 3),
        ]

        return regions.sort(() => Math.random() - 0.5)
      }

      // 在指定区域内生成网格位置
      function generateRegion(startX, startY, width, height, cols, rows) {
        const positions = []
        const cellW = width / cols
        const cellH = height / rows

        for (let row = 0; row < rows; row++) {
          for (let col = 0; col < cols; col++) {
            const baseX = startX + col * cellW + cellW * 0.1
            const baseY = startY + row * cellH + cellH * 0.1

            // 随机偏移
            const offsetX = (Math.random() - 0.5) * cellW * 0.5
            const offsetY = (Math.random() - 0.5) * cellH * 0.5

            const x = Math.max(20, Math.min(SCENE_WIDTH - 400, baseX + offsetX))
            const y = Math.max(20, Math.min(SCENE_HEIGHT - 120, baseY + offsetY))

            positions.push({ x, y })
          }
        }
        return positions
      }

      // 创建代码层 - 随机大小
      function createCodeLayer(x, y, depth, snippet) {
        const div = document.createElement('div')
        div.className = `code-layer depth-${depth}`

        const pre = document.createElement('pre')
        const code = document.createElement('code')
        code.className = 'language-typescript hljs'
        code.innerHTML = highlightCode(snippet)

        pre.appendChild(code)
        div.appendChild(pre)

        div.style.left = `${x}px`
        div.style.top = `${y}px`

        // 随机大小变化 - 让代码看起来更有层次感
        const baseSizes = { 1: 10, 2: 12, 3: 14, 4: 16, 5: 18 }
        const baseSize = baseSizes[depth] || 14
        const randomSize = baseSize + (Math.random() - 0.5) * 6 // ±3px 变化
        div.style.fontSize = `${randomSize}px`

        // 随机轻微旋转 - 让布局更自然
        const rotation = (Math.random() - 0.5) * 4 // ±2度
        div.style.transform = `rotate(${rotation}deg)`

        scene.appendChild(div)
      }

      // 生成背景
      function generateBackground() {
        const positions = generateGridPositions()
        const usedSnippets = new Set()

        // 每个深度层级放置的数量
        const depthConfig = [
          { depth: 1, count: 9 },
          { depth: 2, count: 8 },
          { depth: 3, count: 7 },
          { depth: 4, count: 6 },
          { depth: 5, count: 5 },
        ]

        let posIndex = 0

        depthConfig.forEach(({ depth, count }) => {
          for (let i = 0; i < count && posIndex < positions.length; i++) {
            // 随机选择一个未使用的代码片段
            let snippetIndex
            let attempts = 0
            do {
              snippetIndex = Math.floor(Math.random() * codeSnippets.length)
              attempts++
            } while (usedSnippets.has(snippetIndex) && attempts < 50)

            usedSnippets.add(snippetIndex)

            const pos = positions[posIndex++]
            createCodeLayer(pos.x, pos.y, depth, codeSnippets[snippetIndex])
          }
        })
      }

      // 导出图片功能
      const exportBtn = document.getElementById('exportBtn')

      async function exportImage() {
        if (!window.html2canvas) {
          alert('导出功能加载失败，请刷新页面重试')
          return
        }

        exportBtn.disabled = true
        exportBtn.textContent = '导出中...'

        try {
          exportBtn.style.display = 'none'
          await new Promise((resolve) => setTimeout(resolve, 100))

          const canvas = await html2canvas(scene, {
            scale: 2,
            backgroundColor: '#0d1117',
            useCORS: true,
            logging: false,
            foreignObjectRendering: true,
            ignoreElements: (element) => element.id === 'exportBtn',
          })

          exportBtn.style.display = 'block'

          const link = document.createElement('a')
          link.download = `code-art-${Date.now()}.png`
          link.href = canvas.toDataURL('image/png')
          link.click()

          exportBtn.textContent = '导出成功！'
          setTimeout(() => {
            exportBtn.textContent = '导出图片'
          }, 2000)
        } catch (error) {
          console.error('导出失败:', error)
          alert('导出失败，请重试')
          exportBtn.textContent = '导出图片'
        } finally {
          exportBtn.disabled = false
        }
      }

      exportBtn.addEventListener('click', exportImage)

      // 初始化
      generateBackground()

      // 设置中央代码
      const centerCode = `type Container = { [key: string]: never }
const value: Container = {}`
      sloganEl.innerHTML = highlightCode(centerCode)
    </script>
  </body>
</html>
